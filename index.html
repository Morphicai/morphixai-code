<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="shortcut icon" type="image/x-icon" href="https://morphicai.app/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="MorphixAI Simple Template - Demonstrating iframe embedding and browser communication">
    <title>MorphixAI Code</title>
    
    <!-- 支持 iframe 嵌入的安全策略 -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:;
      frame-src 'self' https://app-shell.focusbe.com https://app-shell.dev.baibian.app http://localhost:3002 http://127.0.0.1:3002 http://localhost:3000 http://127.0.0.1:3000;
      connect-src 'self' https://app-shell.focusbe.com https://app-shell.dev.baibian.app http://localhost:3002 http://127.0.0.1:3002 http://localhost:3000 http://127.0.0.1:3000 ws: wss:;
      img-src 'self' data: blob: https:;
      script-src 'self' 'unsafe-inline' 'unsafe-eval';
      style-src 'self' 'unsafe-inline' https:;
    ">
    
    <!-- 浏览器通信脚本 -->
    <script>
      // 全局通信管理器
      window.AppShellCommunication = {
        listeners: new Set(),
        
        // 添加消息监听器
        addListener: function(callback) {
          this.listeners.add(callback);
          return () => this.listeners.delete(callback);
        },
        
        // 发送消息到所有 iframe
        sendToAllIframes: function(message) {
          const iframes = document.querySelectorAll('iframe[data-app-shell="true"]');
          iframes.forEach(iframe => {
            if (iframe.contentWindow) {
              iframe.contentWindow.postMessage(message, '*');
            }
          });
        },
        
        // 初始化通信
        init: function() {
          window.addEventListener('message', (event) => {
            // 验证消息来源
            const allowedOrigins = [
              'https://app-shell.focusbe.com',
              'https://app-shell.dev.baibian.app',
              'http://localhost:3002',  // 开发环境主端口
              'http://127.0.0.1:3002', // 开发环境 (IP)
              'http://localhost:3000',
              'http://127.0.0.1:3000'
            ];
            
            if (!allowedOrigins.includes(event.origin)) return;
            
            // 分发消息给所有监听器
            this.listeners.forEach(listener => {
              try {
                listener(event);
              } catch (error) {
                console.error('Error in message listener:', error);
              }
            });
          });
          
          console.log('AppShell Communication initialized');
        }
      };
      
      // 页面加载时初始化
      document.addEventListener('DOMContentLoaded', function() {
        window.AppShellCommunication.init();
      });
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
