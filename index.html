<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="shortcut icon" type="image/x-icon" href="https://baibian.app/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="MorphixAI Simple Template - Demonstrating iframe embedding and browser communication">
    <title>MorphixAI Code</title>
    
    <!-- 支持 iframe 嵌入的安全策略 -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;
      frame-src   *;
      child-src   *;
      frame-ancestors *;
      connect-src * ws: wss:;
      img-src     * data: blob:;
      media-src   *;
      font-src    * data:;
      script-src  * 'unsafe-inline' 'unsafe-eval';
      style-src   * 'unsafe-inline';
      worker-src  * blob: data:;
      manifest-src *;
      prefetch-src *;
      base-uri    *;
      form-action *;
    ">
    
    <!-- 浏览器通信脚本 -->
    <script>
      // 全局通信管理器
      window.AppShellCommunication = {
        listeners: new Set(),
        
        // 添加消息监听器
        addListener: function(callback) {
          this.listeners.add(callback);
          return () => this.listeners.delete(callback);
        },
        
        // 发送消息到所有 iframe
        sendToAllIframes: function(message) {
          const iframes = document.querySelectorAll('iframe[data-app-shell="true"]');
          iframes.forEach(iframe => {
            if (iframe.contentWindow) {
              iframe.contentWindow.postMessage(message, '*');
            }
          });
        },
        
        // 初始化通信
        init: function() {
          window.addEventListener('message', (event) => {
            // 验证消息来源（通配规则）
            const isAllowedOrigin = (origin) => {
              try {
                const u = new URL(origin);
                const host = u.hostname;
                // 本地任意端口
                if (host === 'localhost' || host === '127.0.0.1') return true;
                // *.focusbe.com 或 *.baibian.app
                if (host === 'focusbe.com' || host.endsWith('.focusbe.com')) return true;
                if (host === 'baibian.app' || host.endsWith('.baibian.app')) return true;
                return false;
              } catch {
                return false;
              }
            };

            if (!isAllowedOrigin(event.origin)) return;
            
            // 分发消息给所有监听器
            this.listeners.forEach(listener => {
              try {
                listener(event);
              } catch (error) {
                console.error('Error in message listener:', error);
              }
            });
          });
          
          console.log('AppShell Communication initialized');
        }
      };
      
      // 页面加载时初始化
      document.addEventListener('DOMContentLoaded', function() {
        window.AppShellCommunication.init();
      });
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/_dev/main.jsx"></script>
  </body>
</html>
